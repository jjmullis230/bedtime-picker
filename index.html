<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fair Bedtime Picker</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background:#0b1220; color:#eef2ff; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 18px; }
    h1 { font-size: 22px; margin: 8px 0 14px; }
    .card { background:#121a2c; border:1px solid #23304f; border-radius: 14px; padding: 14px; margin: 12px 0; }
    .row { display:flex; gap: 12px; flex-wrap: wrap; }
    .col { flex: 1 1 280px; }
    label { display:block; font-size: 13px; opacity:.9; margin-bottom: 6px; }
    input[type="text"], textarea, select { width:100%; padding: 12px; border-radius: 12px; border:1px solid #2b3a5f; background:#0e1628; color:#eef2ff; }
    textarea { min-height: 120px; resize: vertical; }
    .btnrow { display:flex; gap:10px; flex-wrap: wrap; margin-top: 10px; }
    button { padding: 12px 14px; border-radius: 14px; border: 1px solid #2b3a5f; background:#0e1628; color:#eef2ff; font-weight: 650; }
    button.primary { background:#1f3bff; border-color:#1f3bff; }
    button.good { background:#1b7f4a; border-color:#1b7f4a; }
    button.bad { background:#b42318; border-color:#b42318; }
    button.ghost { background:transparent; }
    .pill { display:inline-block; padding: 6px 10px; border-radius: 999px; border:1px solid #2b3a5f; background:#0e1628; margin: 6px 6px 0 0; font-size: 12px; }
    .small { font-size: 12px; opacity:.85; line-height: 1.35; }
    .opt { display:flex; gap:10px; align-items:center; margin-top: 8px; }
    .opt input { transform: scale(1.2); }
    .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .result { border-top:1px solid #23304f; padding-top: 10px; margin-top: 10px; }
    .title { font-size: 16px; font-weight: 750; margin: 0; }
    .meta { font-size: 12px; opacity:.9; margin-top: 4px; }
    .why { margin-top: 8px; }
    .divider { height:1px; background:#23304f; margin: 12px 0; }
    .warn { background:#2b1b1b; border:1px solid #5a2a2a; padding:10px; border-radius:12px; margin-top:10px; }
    .ok { background:#152b1b; border:1px solid #2a5a36; padding:10px; border-radius:12px; margin-top:10px; }
    .list { margin-top:10px; }
    .listItem { display:flex; justify-content:space-between; gap:10px; padding:10px; border:1px solid #23304f; border-radius:12px; margin-top:8px; background:#0e1628; }
    .listItem b { font-size: 13px; }
    .listItem .sub { font-size: 12px; opacity:.85; margin-top:4px; }
  </style>
</head>
<body>
<div class="wrap">
  <h1>Fair Bedtime Picker (US • Ages 7–13 • Never Scary)</h1>

  <div class="card">
    <div class="row">
      <div class="col">
        <label>Mode</label>
        <div class="btnrow">
          <button id="modeBed" class="primary" type="button">Bedtime</button>
          <button id="modeWknd" type="button">Weekend</button>
        </div>
        <div class="small" id="modeNote" style="margin-top:8px;">
          Bedtime = calmer, lower tension, avoid cliffhangers.
        </div>

        <div class="divider"></div>
        <label>Platforms (toggle on/off)</label>
        <div class="grid2">
          <div class="opt"><input id="pNetflix" type="checkbox" checked><span>Netflix</span></div>
          <div class="opt"><input id="pDisney" type="checkbox" checked><span>Disney+</span></div>
          <div class="opt"><input id="pParamount" type="checkbox" checked><span>Paramount+</span></div>
          <div class="opt"><input id="pPeacock" type="checkbox" checked><span>Peacock</span></div>
        </div>
        <div class="small" style="margin-top:8px;">
          This app uses a big approved list. Streaming catalogs rotate.
        </div>

        <div class="divider"></div>
        <div class="small" id="libStatus">Library: loading…</div>
      </div>

      <div class="col">
        <label>Quick filters (optional)</label>
        <div class="opt"><input id="fShort" type="checkbox"><span>Short episodes only</span></div>
        <div class="opt"><input id="fNoLoud" type="checkbox"><span>No loud / chaotic</span></div>
        <div class="opt"><input id="fNoSad" type="checkbox"><span>No sad themes</span></div>
        <div class="opt"><input id="fNoFight" type="checkbox"><span>No fighting</span></div>
        <div class="opt"><input id="fMoviesOK" type="checkbox" checked><span>Movies allowed</span></div>
        <div class="opt"><input id="fShowsOK" type="checkbox" checked><span>Shows allowed</span></div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <div class="col">
        <label>H’s pick (title or “type”)</label>
        <input id="pickA" type="text" placeholder="Example: Is It Cake / camp comedy / funny baking" />
      </div>
      <div class="col">
        <label>K’s pick (title or “type”)</label>
        <input id="pickB" type="text" placeholder="Example: Nailed It / Fuller House / sitcom comfort" />
      </div>
    </div>
    <div class="btnrow">
      <button id="go" class="primary" type="button">Get 3 picks</button>
      <button id="reroll" type="button">Reroll</button>
      <button id="openAdd" class="ghost" type="button">Add titles (bulk)</button>
      <button id="reset" class="bad" type="button">Reset memory</button>
    </div>
    <div class="small" style="margin-top:8px;">
      Remembers likes/dislikes + your added titles on this device.
    </div>
  </div>

  <div class="card" id="addCard" style="display:none;">
    <label>Paste titles (one per line)</label>
    <textarea id="bulkText" placeholder="Format: Title | Platform | show/movie | bedtime(yes/no) | weekend(yes/no)
Example:
Is It Cake? | Netflix | show | no | yes
Fuller House | Netflix | show | yes | yes"></textarea>

    <div class="row">
      <div class="col">
        <label>Default platform if missing</label>
        <select id="bulkDefaultPlatform">
          <option>Netflix</option>
          <option>Disney+</option>
          <option>Paramount+</option>
          <option>Peacock</option>
        </select>
      </div>
      <div class="col">
        <label>Default type if missing</label>
        <select id="bulkDefaultKind">
          <option value="show">Show</option>
          <option value="movie">Movie</option>
        </select>
      </div>
    </div>

    <div class="btnrow">
      <button id="saveBulk" class="primary" type="button">Import titles</button>
      <button id="closeAdd" type="button">Close</button>
      <button id="clearCustom" class="bad" type="button">Clear my added titles</button>
    </div>

    <div id="addMsg" class="small" style="margin-top:10px;"></div>

    <div class="divider"></div>
    <div class="small">Your added titles (tap remove):</div>
    <div id="customList" class="list"></div>
  </div>

  <div class="card" id="outCard" style="display:none;">
    <div class="small">
      <span class="pill" id="modePill"></span>
      <span class="pill" id="fairPill"></span>
      <span class="pill" id="memPill"></span>
      <span class="pill" id="platPill"></span>
      <span class="pill" id="poolPill"></span>
    </div>
    <div id="results"></div>
  </div>
</div>

<script>
/* ===========
   Storage
=========== */
const STORAGE_KEY = "fairPickerMemory_v5";
const DEFAULT_MEMORY = {
  mode: "Bedtime",
  dislikes: [],
  likes: [],
  recentlyWatched: [],
  lastWinner: null,
  customLib: []
};
function loadMem(){ try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || structuredClone(DEFAULT_MEMORY); } catch { return structuredClone(DEFAULT_MEMORY); } }
function saveMem(m){ localStorage.setItem(STORAGE_KEY, JSON.stringify(m)); }
let mem = loadMem();

/* ===========
   Safety
=========== */
const SCARY_WORDS = /(horror|scary|haunted|ghost|demon|possession|slasher|terrify|nightmare|creepy|spooky|killer|zombie|vampire|werewolf|exorc|occult)/i;

/* ===========
   Library loading
   - Main library lives in library.json for reliability.
=========== */
let BASE_LIB = [];
async function loadLibrary(){
  const status = document.getElementById("libStatus");
  try {
    const res = await fetch("./library.json", { cache: "no-store" });
    if (!res.ok) throw new Error("library.json not found (did you create it?)");
    const data = await res.json();
    if (!Array.isArray(data)) throw new Error("library.json must be a JSON array");

    // sanitize
    BASE_LIB = data
      .map(normalizeItem)
      .filter(x => x && x.title && x.platform && (x.kind==="show" || x.kind==="movie"));

    status.textContent = `Library: ${BASE_LIB.length} base titles loaded`;
  } catch (e) {
    BASE_LIB = [];
    status.innerHTML = `<span style="color:#ffb4b4">Library failed to load: ${escapeHtml(e.message)}.</span>`;
  }
}
function normalizeItem(it){
  if (!it || typeof it !== "object") return null;
  const title = String(it.title||"").trim();
  const platform = String(it.platform||"").trim();
  const kind = (String(it.kind||"show").trim().toLowerCase()==="movie") ? "movie" : "show";
  const bedtimeOk = !!it.bedtimeOk;
  const weekendOk = !!it.weekendOk;
  const intensity = (String(it.intensity||"low").toLowerCase()==="medium") ? "medium" : "low";
  const episodeLen = String(it.episodeLen || (kind==="movie"?"movie":"20-30"));
  const preschoolish = !!it.preschoolish;
  const ageMin = Number.isFinite(it.ageMin) ? it.ageMin : 7;
  const ageMax = Number.isFinite(it.ageMax) ? it.ageMax : 13;
  const vibeTags = Array.isArray(it.vibeTags) ? it.vibeTags.map(x=>String(x).toLowerCase()) : [];
  const themes = Array.isArray(it.themes) ? it.themes.map(x=>String(x).toLowerCase()) : [];

  return { title, platform, kind, bedtimeOk, weekendOk, intensity, episodeLen, preschoolish, ageMin, ageMax, vibeTags, themes };
}
function getLib(){
  const custom = Array.isArray(mem.customLib) ? mem.customLib : [];
  return BASE_LIB.concat(custom);
}

/* ===========
   Tagging
=========== */
function tagsFromText(t){
  t = (t||"").toLowerCase();
  const tags = new Set();
  const add = (...xs)=>xs.forEach(x=>tags.add(x));

  if (/(science|experiment|lab|facts|learn|brain|stem)/.test(t)) add("curious","science");
  if (/(animal|pet|zoo|wild|creature|dragon|dino)/.test(t)) add("animals","adventure");
  if (/(funny|comedy|laugh|lol)/.test(t)) add("funny");
  if (/(helper|help|kind|friend|team|family|home|house)/.test(t)) add("kind","comfort");
  if (/(mystery|detective|clue)/.test(t)) add("mystery","clever");
  if (/(cake|bake|nailed|dessert|cook|food)/.test(t)) add("food","competition","funny");
  if (/(game|challenge|competition|contest|ninja|warrior)/.test(t)) add("competition","sports");
  if (/(camp|bunk|sitcom|school)/.test(t)) add("comfort","funny");
  if (/(music|band|sing|dance)/.test(t)) add("music");
  if (/(sports|soccer|basketball|football|baseball)/.test(t)) add("sports");

  if (/(sleep|bedtime|calm|cozy|relax)/.test(t)) add("calm");
  if (/(weekend|exciting|hype)/.test(t)) add("energetic");

  return [...tags];
}
function autoTagsForTitle(title){
  const base = tagsFromText(title);
  return base.length ? base : ["comfort"];
}

/* ===========
   UI helpers
=========== */
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }
function escapeAttr(s){ return escapeHtml(s).replace(/"/g,"&quot;"); }

/* ===========
   Platform / mode checks
=========== */
function getEnabledPlatforms(){
  const enabled = new Set();
  if (document.getElementById("pNetflix").checked) enabled.add("Netflix");
  if (document.getElementById("pDisney").checked) enabled.add("Disney+");
  if (document.getElementById("pParamount").checked) enabled.add("Paramount+");
  if (document.getElementById("pPeacock").checked) enabled.add("Peacock");
  return enabled;
}
function modeOk(item, mode){
  return mode === "Bedtime" ? item.bedtimeOk : item.weekendOk;
}
function kindOk(item){
  const moviesOk = document.getElementById("fMoviesOK").checked;
  const showsOk  = document.getElementById("fShowsOK").checked;
  return (item.kind === "movie" && moviesOk) || (item.kind === "show" && showsOk);
}
function isExplicitlyTyped(title){
  const a = (document.getElementById("pickA").value || "").toLowerCase();
  const b = (document.getElementById("pickB").value || "").toLowerCase();
  const t = (title || "").toLowerCase();
  const loose = t.replace(/[^\w]+/g,"");
  const a2 = a.replace(/[^\w]+/g,"");
  const b2 = b.replace(/[^\w]+/g,"");
  return a.includes(t) || b.includes(t) || a2.includes(loose) || b2.includes(loose);
}
function violatesFilters(item){
  const enabled = getEnabledPlatforms();
  if (!enabled.has(item.platform)) return true;

  // age target
  if (item.ageMax < 7 || item.ageMin > 13) return true;

  if (!kindOk(item)) return true;
  if (mem.dislikes.includes(item.title)) return true;

  // typed-only suppression for babyish
  if (item.preschoolish && !isExplicitlyTyped(item.title)) return true;

  // avoid repeats last 7 days
  const weekMs = 7*24*60*60*1000;
  if (mem.recentlyWatched.some(x => x.title === item.title && (Date.now()-x.ts) < weekMs)) return true;

  // quick filters
  const shortOnly = document.getElementById("fShort").checked;
  const noLoud = document.getElementById("fNoLoud").checked;
  const noSad = document.getElementById("fNoSad").checked;
  const noFight = document.getElementById("fNoFight").checked;

  if (shortOnly && !["short","10-20","20-30","movie"].includes(item.episodeLen)) return true;
  if (noLoud && item.intensity === "medium") return true;
  if (noSad && /sad/.test((item.vibeTags||[]).join(" "))) return true;
  if (noFight && /fight|battle|violence/.test((item.themes||[]).join(" "))) return true;

  return false;
}

/* ===========
   Scoring
=========== */
function scoreItem(item, tagsA, tagsB, mode){
  const overlap = new Set([...tagsA].filter(x => tagsB.includes(x)));
  let score = overlap.size * 3;

  const allTags = new Set([...tagsA, ...tagsB]);
  for (const t of allTags) {
    if ((item.vibeTags||[]).includes(t) || (item.themes||[]).includes(t)) score += 2;
  }

  if (mode === "Bedtime") {
    if (item.intensity === "low") score += 6;
    if (item.intensity === "medium") score -= 3;
    if (["short","10-20","20-30"].includes(item.episodeLen)) score += 1;
    if (item.kind === "movie") score -= 1;
  } else {
    if (item.intensity === "medium") score += 2;
    if (item.kind === "movie") score += 1;
  }

  // fairness nudge
  if (mem.lastWinner === "H") {
    const kFit = tagsB.filter(t => (item.vibeTags||[]).includes(t) || (item.themes||[]).includes(t)).length;
    score += kFit;
  }
  if (mem.lastWinner === "K") {
    const hFit = tagsA.filter(t => (item.vibeTags||[]).includes(t) || (item.themes||[]).includes(t)).length;
    score += hFit;
  }

  return score;
}

/* ===========
   Recommend
=========== */
function shuffle(arr){
  const a = arr.slice();
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

function recentKeyForMode(mode){
  return "bp_recent_" + (mode || "any").toLowerCase();
}

function getRecentSet(mode){
  const key = recentKeyForMode(mode);
  const recent = JSON.parse(localStorage.getItem(key) || "[]");
  return { key, set: new Set(recent.map(x => String(x).toLowerCase())) };
}

function saveRecent(key, titles){
  const existing = JSON.parse(localStorage.getItem(key) || "[]");
  const next = [...titles, ...existing].slice(0, 30); // keep last 30
  localStorage.setItem(key, JSON.stringify(next));
}
function pick3(){
  const pickA = document.getElementById("pickA").value.trim();
  const pickB = document.getElementById("pickB").value.trim();
  const mode = mem.mode;

  const scaryRequested = SCARY_WORDS.test(pickA) || SCARY_WORDS.test(pickB);

  let tagsA = tagsFromText(pickA);
  let tagsB = tagsFromText(pickB);

  if (tagsA.length === 0) tagsA = [mode==="Bedtime" ? "comfort" : "funny"];
  if (tagsB.length === 0) tagsB = [mode==="Bedtime" ? "comfort" : "funny"];

  if (scaryRequested) { tagsA = ["comfort","funny"]; tagsB = ["comfort","curious"]; }

  const lib = getLib();
  const candidates = [];
  for (const item of lib) {
    if (!modeOk(item, mode)) continue;
    if (violatesFilters(item)) continue;
    const sc = scoreItem(item, tagsA, tagsB, mode);
    candidates.push({ item, sc });
  }
  candidates.sort((a,b)=>b.sc - a.sc);

// Take a bigger bucket of good matches, then randomize
const topBucketSize = Math.min(60, candidates.length);
let bucket = candidates.slice(0, topBucketSize);

// Avoid repeats
const { key: rKey, set: recentSet } = getRecentSet(mode);
bucket = bucket.filter(x => !recentSet.has(String(x.item.title).toLowerCase()));

// If the repeat filter makes it too small, relax it a bit
if (bucket.length < 10) bucket = candidates.slice(0, Math.min(80, candidates.length));

// Shuffle and take 3
bucket = shuffle(bucket);
let top = bucket.slice(0, 3);

// Save picked titles so next click changes
saveRecent(rKey, top.map(x => x.item.title));

  // fallback: ignore repeat rule only
  if (top.length < 3) {
    const enabled = getEnabledPlatforms();
    const relaxed = [];
    for (const item of lib) {
      if (!enabled.has(item.platform)) continue;
      if (!modeOk(item, mode)) continue;
      if (!kindOk(item)) continue;
      if (mem.dislikes.includes(item.title)) continue;
      if (item.preschoolish && !isExplicitlyTyped(item.title)) continue;
      const sc = scoreItem(item, tagsA, tagsB, mode);
      relaxed.push({ item, sc });
    }
    relaxed.sort((a,b)=>b.sc - a.sc);
    top = relaxed.slice(0,3);
  }

  renderResults(top, { pickA, pickB, mode, scaryRequested, poolCount: candidates.length, totalCount: lib.length });
}

function renderResults(top, ctx){
  const out = document.getElementById("outCard");
  out.style.display = "block";

  document.getElementById("modePill").textContent = `Mode: ${ctx.mode}`;
  document.getElementById("fairPill").textContent = `Fairness: last winner ${mem.lastWinner || "none"}`;
  document.getElementById("memPill").textContent = `Memory: ${mem.likes.length} likes • ${mem.dislikes.length} no-thanks`;
  document.getElementById("platPill").textContent = `Platforms: ${[...getEnabledPlatforms()].join(", ") || "none"}`;
  document.getElementById("poolPill").textContent = `Pool: ${ctx.poolCount} matches • Library: ${ctx.totalCount}`;

  const container = document.getElementById("results");
  container.innerHTML = `
    <div class="small">
      <div><strong>H:</strong> ${escapeHtml(ctx.pickA || "(none)")}</div>
      <div><strong>K:</strong> ${escapeHtml(ctx.pickB || "(none)")}</div>
      ${ctx.scaryRequested ? `<div class="warn"><strong>Blocked:</strong> scary requests. Showing safe picks only.</div>` : ""}
    </div>
    <div class="divider"></div>
  `;

  top.forEach((x, idx) => {
    const it = x.item;
    const div = document.createElement("div");
    div.className = "result";
    div.innerHTML = `
      <p class="title">${idx+1}. ${escapeHtml(it.title)}</p>
      <div class="meta">${escapeHtml(it.platform)} • ${escapeHtml(it.kind)} • ${escapeHtml(it.episodeLen)} • intensity: ${escapeHtml(it.intensity)}</div>
      <div class="why">${escapeHtml(ctx.mode === "Bedtime" ? "Good bedtime fit based on both picks." : "Good weekend fit based on both picks.")}</div>
      <div class="btnrow" style="margin-top:10px;">
        <button class="good" type="button" data-act="watched" data-title="${escapeAttr(it.title)}">We watched it</button>
        <button class="bad" type="button" data-act="dislike" data-title="${escapeAttr(it.title)}">No thanks</button>
      </div>
    `;
    container.appendChild(div);
  });

  container.onclick = (e) => {
    const btn = e.target.closest("button[data-act]");
    if (!btn) return;
    const act = btn.getAttribute("data-act");
    const title = btn.getAttribute("data-title");
    if (!title) return;

    if (act === "watched") {
      if (!mem.likes.includes(title)) mem.likes.push(title);
      mem.recentlyWatched.unshift({ title, ts: Date.now() });
      mem.recentlyWatched = mem.recentlyWatched.slice(0, 200);

      const lib = getLib();
      const item = lib.find(x=>x.title===title);
      const aFit = tagsFromText(document.getElementById("pickA").value).filter(t => (item.vibeTags||[]).includes(t) || (item.themes||[]).includes(t)).length;
      const bFit = tagsFromText(document.getElementById("pickB").value).filter(t => (item.vibeTags||[]).includes(t) || (item.themes||[]).includes(t)).length;
      mem.lastWinner = (aFit === bFit) ? (mem.lastWinner === "H" ? "K" : "H") : (aFit > bFit ? "H" : "K");

      saveMem(mem);
      pick3();
    } else if (act === "dislike") {
      if (!mem.dislikes.includes(title)) mem.dislikes.push(title);
      mem.likes = mem.likes.filter(x=>x!==title);
      saveMem(mem);
      pick3();
    }
  };
}

/* ===========
   Mode
=========== */
function setMode(mode){
  mem.mode = mode;
  saveMem(mem);
  const bed = document.getElementById("modeBed");
  const wk = document.getElementById("modeWknd");
  const note = document.getElementById("modeNote");
  if (mode === "Bedtime") {
    bed.classList.add("primary"); wk.classList.remove("primary");
    note.textContent = "Bedtime = calmer, lower tension, avoid cliffhangers.";
  } else {
    wk.classList.add("primary"); bed.classList.remove("primary");
    note.textContent = "Weekend = more energy allowed (still safe, never scary).";
  }
}

/* ===========
   Bulk import (custom titles)
=========== */
function showAdd(open){
  document.getElementById("addCard").style.display = open ? "block" : "none";
  if (open) renderCustomList();
}
function normalizeTitle(s){ return (s||"").trim().replace(/\s+/g," "); }

function parseLine(line, defaults){
  // Title | Platform | show/movie | bedtime yes/no | weekend yes/no
  const parts = line.split("|").map(x=>x.trim()).filter(Boolean);
  if (parts.length === 0) return null;

  const title = normalizeTitle(parts[0] || "");
  if (!title) return null;
  if (SCARY_WORDS.test(title)) return { skip:true, reason:"scary keyword", title };

  const platform = (parts[1] || defaults.platform || "Netflix");
  const kind = (String(parts[2] || defaults.kind || "show").toLowerCase()==="movie") ? "movie" : "show";

  const bed = String(parts[3] || "yes").toLowerCase();
  const wk  = String(parts[4] || "yes").toLowerCase();
  const bedtimeOk = !(bed==="no" || bed==="false" || bed==="0");
  const weekendOk = !(wk==="no" || wk==="false" || wk==="0");

  const tags = autoTagsForTitle(title);
  const vibeTags = tags.filter(t=>["funny","comfort","competition","curious","clever","music","uplifting","adventure","chaotic","fast"].includes(t));
  const themes = tags.filter(t=>!vibeTags.includes(t));
  if (vibeTags.length === 0) vibeTags.push("comfort");
  if (themes.length === 0) themes.push("family");

  // default intensity/len
  const intensity = (kind==="movie") ? "medium" : "low";
  const episodeLen = (kind==="movie") ? "movie" : "20-30";

  return normalizeItem({
    title, platform, kind, bedtimeOk, weekendOk, intensity, episodeLen,
    preschoolish:false, ageMin:7, ageMax:13, vibeTags, themes
  });
}

function importBulk(){
  const msg = document.getElementById("addMsg");
  msg.textContent = "";

  const text = document.getElementById("bulkText").value || "";
  const lines = text.split("\n").map(x=>x.trim()).filter(Boolean);

  const defaults = {
    platform: document.getElementById("bulkDefaultPlatform").value,
    kind: document.getElementById("bulkDefaultKind").value
  };

  if (lines.length === 0) { msg.textContent = "Paste at least one line."; return; }

  mem.customLib = Array.isArray(mem.customLib) ? mem.customLib : [];

  let added = 0, skipped = 0, dup = 0;
  for (const line of lines) {
    const parsed = parseLine(line, defaults);
    if (!parsed) { skipped++; continue; }
    if (parsed.skip) { skipped++; continue; }

    const key = `${parsed.title}||${parsed.platform}||${parsed.kind}`.toLowerCase();
    const exists = mem.customLib.some(x => `${x.title}||${x.platform}||${x.kind}`.toLowerCase() === key);
    if (exists) { dup++; continue; }

    mem.customLib.unshift(parsed);
    added++;
  }

  mem.customLib = mem.customLib.slice(0, 800);
  saveMem(mem);

  msg.innerHTML = `<div class="ok"><strong>Imported:</strong> ${added} added • ${dup} duplicates ignored • ${skipped} skipped</div>`;
  renderCustomList();
}

function renderCustomList(){
  const box = document.getElementById("customList");
  const items = Array.isArray(mem.customLib) ? mem.customLib : [];
  box.innerHTML = "";

  if (items.length === 0) {
    box.innerHTML = `<div class="small">No custom titles yet.</div>`;
    return;
  }

  items.slice(0, 40).forEach((it, idx) => {
    const d = document.createElement("div");
    d.className = "listItem";
    d.innerHTML = `
      <div>
        <b>${escapeHtml(it.title)}</b>
        <div class="sub">${escapeHtml(it.platform)} • ${escapeHtml(it.kind)} • ${it.bedtimeOk ? "Bedtime" : ""}${it.bedtimeOk && it.weekendOk ? " & " : ""}${it.weekendOk ? "Weekend" : ""}</div>
      </div>
      <div><button class="bad" type="button" data-rm="${idx}">Remove</button></div>
    `;
    box.appendChild(d);
  });

  box.onclick = (e) => {
    const btn = e.target.closest("button[data-rm]");
    if (!btn) return;
    const idx = parseInt(btn.getAttribute("data-rm"), 10);
    if (Number.isNaN(idx)) return;
    mem.customLib.splice(idx, 1);
    saveMem(mem);
    renderCustomList();
  };
}

/* ===========
   Wire up
=========== */
document.getElementById("modeBed").addEventListener("click", ()=>setMode("Bedtime"));
document.getElementById("modeWknd").addEventListener("click", ()=>setMode("Weekend"));
document.getElementById("go").addEventListener("click", pick3);
document.getElementById("reroll").addEventListener("click", pick3);

document.getElementById("openAdd").addEventListener("click", ()=>showAdd(true));
document.getElementById("closeAdd").addEventListener("click", ()=>showAdd(false));
document.getElementById("saveBulk").addEventListener("click", importBulk);
document.getElementById("clearCustom").addEventListener("click", ()=>{
  mem.customLib = [];
  saveMem(mem);
  renderCustomList();
  document.getElementById("addMsg").innerHTML = `<div class="ok">Cleared your added titles.</div>`;
});

document.getElementById("reset").addEventListener("click", ()=>{
  localStorage.removeItem(STORAGE_KEY);
  mem = loadMem();
  setMode(mem.mode);
  showAdd(false);
  document.getElementById("outCard").style.display = "none";
});

["pNetflix","pDisney","pParamount","pPeacock","fShort","fNoLoud","fNoSad","fNoFight","fMoviesOK","fShowsOK"].forEach(id=>{
  document.getElementById(id).addEventListener("change", ()=>{
    if (document.getElementById("outCard").style.display !== "none") pick3();
  });
});

// init
setMode(mem.mode);
loadLibrary();
</script>
</body>
</html>