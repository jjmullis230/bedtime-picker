<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fair Bedtime Picker</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background:#0b1220; color:#eef2ff; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 18px; }
    h1 { font-size: 22px; margin: 8px 0 14px; }
    .card { background:#121a2c; border:1px solid #23304f; border-radius: 14px; padding: 14px; margin: 12px 0; }
    .row { display:flex; gap: 12px; flex-wrap: wrap; }
    .col { flex: 1 1 280px; }
    label { display:block; font-size: 13px; opacity:.9; margin-bottom: 6px; }
    input[type="text"], select { width:100%; padding: 12px; border-radius: 12px; border:1px solid #2b3a5f; background:#0e1628; color:#eef2ff; }
    .btnrow { display:flex; gap:10px; flex-wrap: wrap; margin-top: 10px; }
    button { padding: 12px 14px; border-radius: 14px; border: 1px solid #2b3a5f; background:#0e1628; color:#eef2ff; font-weight: 650; }
    button.primary { background:#1f3bff; border-color:#1f3bff; }
    button.good { background:#1b7f4a; border-color:#1b7f4a; }
    button.bad { background:#b42318; border-color:#b42318; }
    button.ghost { background:transparent; }
    .pill { display:inline-block; padding: 6px 10px; border-radius: 999px; border:1px solid #2b3a5f; background:#0e1628; margin: 6px 6px 0 0; font-size: 12px; }
    .small { font-size: 12px; opacity:.85; line-height: 1.35; }
    .opt { display:flex; gap:10px; align-items:center; margin-top: 8px; }
    .opt input { transform: scale(1.2); }
    .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .result { border-top:1px solid #23304f; padding-top: 10px; margin-top: 10px; }
    .title { font-size: 16px; font-weight: 750; margin: 0; }
    .meta { font-size: 12px; opacity:.9; margin-top: 4px; }
    .why { margin-top: 8px; }
    .divider { height:1px; background:#23304f; margin: 12px 0; }
    .warn { background:#2b1b1b; border:1px solid #5a2a2a; padding:10px; border-radius:12px; margin-top:10px; }
    .ok { background:#152b1b; border:1px solid #2a5a36; padding:10px; border-radius:12px; margin-top:10px; }
    .list { margin-top:10px; }
    .listItem { display:flex; justify-content:space-between; gap:10px; padding:10px; border:1px solid #23304f; border-radius:12px; margin-top:8px; background:#0e1628; }
    .listItem b { font-size: 13px; }
    .listItem .sub { font-size: 12px; opacity:.85; margin-top:4px; }
  </style>
</head>
<body>
<div class="wrap">
  <h1>Fair Bedtime Picker (US • Ages 7–13 • Never Scary)</h1>

  <div class="card">
    <div class="row">
      <div class="col">
        <label>Mode</label>
        <div class="btnrow">
          <button id="modeBed" class="primary" type="button">Bedtime</button>
          <button id="modeWknd" type="button">Weekend</button>
        </div>
        <div class="small" id="modeNote" style="margin-top:8px;">
          Bedtime = calmer, lower tension, avoid cliffhangers.
        </div>

        <div class="divider"></div>
        <label>Platforms (toggle on/off)</label>
        <div class="grid2">
          <div class="opt"><input id="pNetflix" type="checkbox" checked><span>Netflix</span></div>
          <div class="opt"><input id="pDisney" type="checkbox" checked><span>Disney+</span></div>
          <div class="opt"><input id="pParamount" type="checkbox" checked><span>Paramount+</span></div>
          <div class="opt"><input id="pPeacock" type="checkbox" checked><span>Peacock</span></div>
        </div>
        <div class="small" style="margin-top:8px;">
          Catalogs change—this app is an “approved list” picker, not a live catalog scraper.
        </div>
      </div>

      <div class="col">
        <label>Quick filters (optional)</label>
        <div class="opt"><input id="fShort" type="checkbox"><span>Short episodes only</span></div>
        <div class="opt"><input id="fNoLoud" type="checkbox"><span>No loud / chaotic</span></div>
        <div class="opt"><input id="fNoSad" type="checkbox"><span>No sad themes</span></div>
        <div class="opt"><input id="fNoFight" type="checkbox"><span>No fighting</span></div>
        <div class="opt"><input id="fMoviesOK" type="checkbox" checked><span>Movies allowed</span></div>
        <div class="opt"><input id="fShowsOK" type="checkbox" checked><span>Shows allowed</span></div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <div class="col">
        <label>H’s pick (title or “type”)</label>
        <input id="pickA" type="text" placeholder="Example: Is It Cake / camp comedy / funny baking" />
      </div>
      <div class="col">
        <label>K’s pick (title or “type”)</label>
        <input id="pickB" type="text" placeholder="Example: Nailed It / Fuller House / sitcom comfort" />
      </div>
    </div>
    <div class="btnrow">
      <button id="go" class="primary" type="button">Get 3 picks</button>
      <button id="reroll" type="button">Reroll</button>
      <button id="openAdd" class="ghost" type="button">Add a title</button>
      <button id="reset" class="bad" type="button">Reset memory</button>
    </div>
    <div class="small" style="margin-top:8px;">
      Remembers likes/dislikes + your added titles on this device.
    </div>
  </div>

  <div class="card" id="addCard" style="display:none;">
    <div class="row">
      <div class="col">
        <label>Title</label>
        <input id="newTitle" type="text" placeholder="Example: The Suite Life on Deck" />
      </div>
      <div class="col">
        <label>Platform</label>
        <select id="newPlatform">
          <option>Netflix</option>
          <option>Disney+</option>
          <option>Paramount+</option>
          <option>Peacock</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label>Type</label>
        <select id="newKind">
          <option value="show">Show</option>
          <option value="movie">Movie</option>
        </select>
      </div>
      <div class="col">
        <label>Intensity</label>
        <select id="newIntensity">
          <option value="low">Low (best for Bedtime)</option>
          <option value="medium" selected>Medium (more Weekend)</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label>Tags (optional, comma separated)</label>
        <input id="newTags" type="text" placeholder="funny, comfort, competition, science, music, sports" />
        <div class="small" style="margin-top:6px;">
          Leave blank and the app will auto-tag from the title.
        </div>
      </div>
      <div class="col">
        <label>Where it fits</label>
        <div class="opt"><input id="newBedOk" type="checkbox" checked><span>Bedtime OK</span></div>
        <div class="opt"><input id="newWkndOk" type="checkbox" checked><span>Weekend OK</span></div>
        <div class="opt"><input id="newPreschool" type="checkbox"><span>Mark as “too babyish” (only shows if typed)</span></div>
      </div>
    </div>

    <div class="btnrow">
      <button id="saveAdd" class="primary" type="button">Save title</button>
      <button id="closeAdd" type="button">Close</button>
    </div>

    <div id="addMsg" class="small" style="margin-top:10px;"></div>

    <div class="divider"></div>
    <div class="small">Your added titles (tap remove):</div>
    <div id="customList" class="list"></div>
  </div>

  <div class="card" id="outCard" style="display:none;">
    <div class="small">
      <span class="pill" id="modePill"></span>
      <span class="pill" id="fairPill"></span>
      <span class="pill" id="memPill"></span>
      <span class="pill" id="platPill"></span>
      <span class="pill" id="poolPill"></span>
    </div>
    <div id="results"></div>
  </div>
</div>

<script>
  // ==========
  // Memory
  // ==========
  const STORAGE_KEY = "fairPickerMemory_v4";

  const DEFAULT_MEMORY = {
    mode: "Bedtime",
    dislikes: [],
    likes: [],
    recentlyWatched: [], // {title, ts}
    lastWinner: null,    // "H" or "K"
    customLib: []        // array of items (same schema as BASE_LIB)
  };

  function loadMem() {
    try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || structuredClone(DEFAULT_MEMORY); }
    catch { return structuredClone(DEFAULT_MEMORY); }
  }
  function saveMem(m){ localStorage.setItem(STORAGE_KEY, JSON.stringify(m)); }
  let mem = loadMem();

  // ==========
  // Safety: NEVER scary
  // ==========
  const SCARY_WORDS = /(horror|scary|haunted|ghost|demon|possession|slasher|terrify|nightmare|creepy|spooky|killer|zombie|vampire|werewolf|exorc|occult)/i;

  // ==========
  // Item builder
  // ==========
  function I(title, platform, kind, vibeTags, themes, intensity, episodeLen, ageMin, ageMax, bedtimeOk, weekendOk, preschoolish=false){
    return { title, platform, kind, vibeTags, themes, intensity, episodeLen, ageMin, ageMax, bedtimeOk, weekendOk, preschoolish };
  }

  // ==========
  // Base library (large starter set)
  // ==========
  // NOTE: “platform” here is the intended platform when added; catalogs rotate.
  const BASE_LIB = [
    // ===== Netflix: your anchors + similar
    I("Is It Cake?","Netflix","show",["funny","competition"],["food","games"],"medium","30-45",8,13,false,true),
    I("Nailed It!","Netflix","show",["funny","competition"],["food","fails"],"medium","30-45",8,13,false,true),
    I("Nailed It! Holiday!","Netflix","show",["funny","competition"],["food","fails","holiday"],"medium","30-45",8,13,false,true),
    I("Floor is Lava","Netflix","show",["funny","competition"],["games","teams"],"medium","30-45",8,13,false,true),
    I("Brainchild","Netflix","show",["curious","fast"],["science","facts"],"medium","20-30",8,13,true,true),
    I("Emily's Wonder Lab","Netflix","show",["curious","fun"],["science","experiments"],"medium","20-30",7,13,true,true),
    I("The Magic School Bus Rides Again","Netflix","show",["curious","adventure"],["science","school"],"low","20-30",7,12,true,true),
    I("Fuller House","Netflix","show",["funny","comfort"],["family","friends"],"low","20-30",8,13,true,true),
    I("Alexa & Katie","Netflix","show",["funny","comfort"],["friends","school","family"],"low","20-30",8,13,true,true),
    I("The Baby-Sitters Club","Netflix","show",["comfort","clever"],["friends","school"],"low","20-30",8,13,true,true),
    I("Carmen Sandiego","Netflix","show",["clever","adventure"],["mystery","travel"],"medium","20-30",8,13,false,true),
    I("The InBESTigators","Netflix","show",["funny","clever"],["mystery","school"],"low","20-30",8,13,true,true),
    I("The Who Was? Show","Netflix","show",["funny","curious"],["history","facts"],"low","20-30",8,13,true,true),
    I("Oddballs","Netflix","show",["funny"],["school","friends"],"medium","20-30",8,13,false,true),
    I("Hilda","Netflix","show",["comfort","adventure"],["friends","mystery"],"low","20-30",8,13,true,true),
    I("Team Zenko Go","Netflix","show",["comfort"],["helpers","friends"],"low","20-30",7,11,true,true),
    I("Green Eggs and Ham","Netflix","show",["funny","adventure"],["friends","travel"],"medium","20-30",7,13,false,true),
    I("Kid Cosmic","Netflix","show",["adventure","funny"],["heroes","friends"],"medium","20-30",8,13,false,true),
    I("My Dad the Bounty Hunter","Netflix","show",["funny","adventure"],["family","space"],"medium","20-30",8,13,false,true),
    I("Dogs in Space","Netflix","show",["funny","adventure"],["space","friends"],"medium","20-30",8,13,false,true),
    I("Project Mc²","Netflix","show",["curious","fun"],["science","friends"],"low","20-30",8,13,true,true),
    I("Pokémon Journeys","Netflix","show",["adventure"],["friends","quests"],"medium","20-30",7,13,false,true),
    I("Pokémon Master Journeys","Netflix","show",["adventure"],["friends","quests"],"medium","20-30",7,13,false,true),
    I("Pokémon Ultimate Journeys","Netflix","show",["adventure"],["friends","quests"],"medium","20-30",7,13,false,true),
    I("LEGO Ninjago","Netflix","show",["adventure"],["heroes","team"],"medium","20-30",8,13,false,true),
    I("Dragons: Race to the Edge","Netflix","show",["adventure","funny"],["dragons","friends"],"medium","20-30",8,13,false,true),

    // Netflix movies
    I("Yes Day","Netflix","movie",["funny","comfort"],["family"],"low","movie",7,13,true,true),
    I("The Mitchells vs. the Machines","Netflix","movie",["funny","adventure"],["family","tech"],"medium","movie",8,13,false,true),
    I("We Can Be Heroes","Netflix","movie",["adventure","funny"],["heroes","family"],"medium","movie",7,13,false,true),
    I("The Willoughbys","Netflix","movie",["funny","adventure"],["family","friends"],"medium","movie",8,13,false,true),
    I("The Sea Beast","Netflix","movie",["adventure","uplifting"],["friends","sea"],"medium","movie",8,13,false,true),
    I("Vivo","Netflix","movie",["funny","music"],["friends","family"],"medium","movie",7,13,false,true),
    I("Enola Holmes","Netflix","movie",["clever","adventure"],["mystery","family"],"medium","movie",10,13,false,true),
    I("Enola Holmes 2","Netflix","movie",["clever","adventure"],["mystery","family"],"medium","movie",10,13,false,true),
    I("A Shaun the Sheep Movie: Farmageddon","Netflix","movie",["funny","adventure"],["animals","friends"],"low","movie",7,13,true,true),

    // ===== Disney+: Bunk’d lane + classics
    I("Bunk’d","Disney+","show",["funny","chaotic"],["camp","friends"],"medium","20-30",7,13,false,true),
    I("Jessie","Disney+","show",["funny","comfort"],["family","friends"],"low","20-30",8,13,true,true),
    I("Liv and Maddie","Disney+","show",["funny","comfort"],["family","school"],"low","20-30",8,13,true,true),
    I("Girl Meets World","Disney+","show",["funny","comfort"],["school","friends","family"],"low","20-30",8,13,true,true),
    I("Austin & Ally","Disney+","show",["funny","music"],["friends","school"],"medium","20-30",8,13,false,true),
    I("Good Luck Charlie","Disney+","show",["funny","comfort"],["family","school"],"low","20-30",8,13,true,true),
    I("Hannah Montana","Disney+","show",["funny","music"],["school","friends"],"medium","20-30",8,13,false,true),
    I("That's So Raven","Disney+","show",["funny"],["school","family"],"medium","20-30",8,13,false,true),
    I("Raven's Home","Disney+","show",["funny","comfort"],["family","school"],"low","20-30",8,13,true,true),
    I("Andi Mack","Disney+","show",["comfort","clever"],["school","friends","family"],"low","20-30",9,13,true,true),
    I("Stuck in the Middle","Disney+","show",["funny","comfort"],["family","school"],"low","20-30",8,13,true,true),
    I("Dog with a Blog","Disney+","show",["funny"],["family","pets"],"low","20-30",8,13,true,true),
    I("Phineas and Ferb","Disney+","show",["funny","creative"],["inventions","music"],"medium","20-30",7,13,true,true),
    I("DuckTales","Disney+","show",["adventure","funny"],["family","treasure"],"medium","20-30",8,13,false,true),
    I("Big City Greens","Disney+","show",["funny","chaotic"],["family","misadventures"],"medium","20-30",8,13,false,true),
    I("Brain Games","Disney+","show",["curious","clever"],["puzzles","brain"],"low","20-30",8,13,true,true),
    I("Marvel's Hero Project","Disney+","show",["uplifting","inspiring"],["real people","helping"],"low","20-30",7,13,true,true),
    I("Pixar in Real Life","Disney+","show",["fun","light"],["kind","pranks"],"low","short",8,13,true,true),

    // Disney+ movies
    I("The Parent Trap","Disney+","movie",["funny","comfort"],["family"],"low","movie",7,13,true,true),
    I("Cool Runnings","Disney+","movie",["funny","uplifting"],["sports","team"],"low","movie",8,13,true,true),
    I("Ratatouille","Disney+","movie",["funny","comfort"],["food","dreams"],"low","movie",7,13,true,true),
    I("Encanto","Disney+","movie",["funny","uplifting"],["family","music"],"medium","movie",7,13,false,true),
    I("Moana","Disney+","movie",["adventure","uplifting"],["family","ocean"],"medium","movie",7,13,false,true),
    I("Zootopia","Disney+","movie",["clever","adventure"],["mystery","friends"],"medium","movie",8,13,false,true),
    I("Inside Out","Disney+","movie",["clever","comfort"],["feelings","family"],"medium","movie",8,13,false,true),
    I("The Incredibles","Disney+","movie",["adventure","funny"],["family","heroes"],"medium","movie",8,13,false,true),
    I("The Princess Diaries","Disney+","movie",["funny","comfort"],["school","family"],"low","movie",9,13,true,true),
    I("Freaky Friday","Disney+","movie",["funny","comfort"],["family","school"],"low","movie",9,13,true,true),
    I("Holes","Disney+","movie",["adventure","clever"],["mystery","friends"],"medium","movie",9,13,false,true),
    I("Remember the Titans","Disney+","movie",["uplifting"],["sports","team"],"medium","movie",10,13,false,true),
    I("The Sandlot","Disney+","movie",["comfort","funny"],["sports","friends"],"low","movie",8,13,true,true),

    // ===== Paramount+: Nickelodeon lane + family movies
    I("iCarly","Paramount+","show",["funny","chaotic"],["friends","school"],"medium","20-30",8,13,false,true),
    I("Victorious","Paramount+","show",["funny","music"],["school","friends"],"medium","20-30",8,13,false,true),
    I("Sam & Cat","Paramount+","show",["funny","chaotic"],["friends","school"],"medium","20-30",9,13,false,true),
    I("Drake & Josh","Paramount+","show",["funny","chaotic"],["family","school"],"medium","20-30",9,13,false,true),
    I("Zoey 101","Paramount+","show",["funny","comfort"],["school","friends"],"low","20-30",9,13,true,true),
    I("Big Time Rush","Paramount+","show",["funny","music"],["friends","band"],"medium","20-30",9,13,false,true),
    I("The Thundermans","Paramount+","show",["funny","adventure"],["family","powers"],"medium","20-30",7,13,false,true),
    I("Henry Danger","Paramount+","show",["funny","adventure"],["heroes","friends"],"medium","20-30",8,13,false,true),
    I("Danger Force","Paramount+","show",["funny","adventure"],["heroes","friends"],"medium","20-30",8,13,false,true),
    I("Game Shakers","Paramount+","show",["funny","tech"],["games","friends"],"medium","20-30",8,13,false,true),
    I("The Loud House","Paramount+","show",["funny","comfort"],["family","siblings"],"medium","20-30",7,13,false,true),
    I("The Casagrandes","Paramount+","show",["funny","comfort"],["family","friends"],"medium","20-30",7,13,false,true),
    I("Double Dare","Paramount+","show",["competition","funny"],["games","challenge"],"medium","20-30",8,13,false,true),
    I("Are You Smarter Than a 5th Grader?","Paramount+","show",["competition","fun"],["trivia","school"],"medium","20-30",8,13,false,true),
    I("Avatar: The Last Airbender","Paramount+","show",["clever","adventure"],["friends","quests"],"medium","20-30",10,13,false,true),

    // Paramount+ movies
    I("Sonic the Hedgehog","Paramount+","movie",["funny","adventure"],["friends","heroes"],"medium","movie",8,13,false,true),
    I("Sonic the Hedgehog 2","Paramount+","movie",["funny","adventure"],["friends","heroes"],"medium","movie",8,13,false,true),
    I("Dora and the Lost City of Gold","Paramount+","movie",["funny","adventure"],["friends","travel"],"medium","movie",8,13,false,true),

    // ===== Peacock: competition + Illumination/DreamWorks style family movies
    I("American Ninja Warrior Junior","Peacock","show",["competition","fun"],["sports","challenge"],"medium","20-30",8,13,false,true),
    I("LEGO Masters","Peacock","show",["competition","fun"],["builds","challenge"],"medium","40-60",9,13,false,true),

    I("Despicable Me","Peacock","movie",["funny","comfort"],["family"],"low","movie",7,13,true,true),
    I("Minions","Peacock","movie",["funny"],["family"],"low","movie",7,12,true,true),
    I("Shrek","Peacock","movie",["funny","adventure"],["friends"],"medium","movie",8,13,false,true),
    I("Kung Fu Panda","Peacock","movie",["funny","adventure"],["training","friends"],"medium","movie",8,13,false,true),
    I("Sing","Peacock","movie",["funny","music"],["talent","friends"],"medium","movie",7,13,false,true),
    I("Sing 2","Peacock","movie",["funny","music"],["talent","friends"],"medium","movie",7,13,false,true),
    I("The Bad Guys","Peacock","movie",["funny","adventure"],["friends","heist"],"medium","movie",8,13,false,true),
    I("Madagascar","Peacock","movie",["funny","adventure"],["animals","friends"],"medium","movie",7,13,false,true),
    I("Megamind","Peacock","movie",["funny","adventure"],["heroes","friends"],"medium","movie",9,13,false,true),
    I("The Secret Life of Pets","Peacock","movie",["funny","adventure"],["pets","friends"],"medium","movie",7,13,false,true),
    I("Trolls","Peacock","movie",["funny","music"],["friends"],"medium","movie",7,13,false,true),
    I("Over the Hedge","Peacock","movie",["funny","adventure"],["animals","friends"],"medium","movie",7,13,false,true),
    I("Bee Movie","Peacock","movie",["funny","comfort"],["friends"],"low","movie",8,13,true,true),

    // ===== “Typed by kid” younger picks (suppressed unless explicitly typed)
    I("Bluey","Disney+","show",["comfort","kind"],["family","life lessons"],"low","short",7,13,true,false,true),
    I("T.O.T.S.","Disney+","show",["kind","comfort"],["helpers","animals"],"low","short",7,10,true,true,true),
  ];

  function getLib(){
    const custom = Array.isArray(mem.customLib) ? mem.customLib : [];
    return BASE_LIB.concat(custom);
  }

  // ==========
  // Tag extraction
  // ==========
  function tagsFromText(t){
    t = (t||"").toLowerCase();
    const tags = new Set();
    const add = (...xs)=>xs.forEach(x=>tags.add(x));

    if (/(science|experiment|lab|facts|learn|brain|stem)/.test(t)) add("curious","science");
    if (/(animal|pet|zoo|wild|creature|dragon)/.test(t)) add("animals","adventure");
    if (/(funny|comedy|laugh|lol)/.test(t)) add("funny");
    if (/(helper|help|kind|friend|team|family|home|house)/.test(t)) add("kind","comfort");
    if (/(mystery|detective|clue|enola)/.test(t)) add("mystery","clever");
    if (/(cake|bake|nailed|dessert|cook|food)/.test(t)) add("food","competition","funny");
    if (/(game|challenge|competition|contest|ninja|warrior)/.test(t)) add("competition","sports");
    if (/(camp|bunk|sitcom|fuller|school)/.test(t)) add("comfort","funny");
    if (/(music|band|sing|dance)/.test(t)) add("music");
    if (/(sports|soccer|basketball|football|baseball)/.test(t)) add("sports");

    if (/(sleep|bedtime|calm|cozy|relax)/.test(t)) add("calm");
    if (/(weekend|exciting|hype)/.test(t)) add("energetic");

    return [...tags];
  }

  function autoTagsForTitle(title){
    const base = tagsFromText(title);
    return base.length ? base : ["comfort"];
  }

  // ==========
  // Filters / scoring
  // ==========
  function getEnabledPlatforms(){
    const enabled = new Set();
    if (document.getElementById("pNetflix").checked) enabled.add("Netflix");
    if (document.getElementById("pDisney").checked) enabled.add("Disney+");
    if (document.getElementById("pParamount").checked) enabled.add("Paramount+");
    if (document.getElementById("pPeacock").checked) enabled.add("Peacock");
    return enabled;
  }

  function modeOk(item, mode){
    return mode === "Bedtime" ? item.bedtimeOk : item.weekendOk;
  }

  function kindOk(item){
    const moviesOk = document.getElementById("fMoviesOK").checked;
    const showsOk  = document.getElementById("fShowsOK").checked;
    return (item.kind === "movie" && moviesOk) || (item.kind === "show" && showsOk);
  }

  function isExplicitlyTyped(title){
    const a = (document.getElementById("pickA").value || "").toLowerCase();
    const b = (document.getElementById("pickB").value || "").toLowerCase();
    const t = (title || "").toLowerCase();
    const loose = t.replace(/[^\w]+/g,"");
    const a2 = a.replace(/[^\w]+/g,"");
    const b2 = b.replace(/[^\w]+/g,"");
    return a.includes(t) || b.includes(t) || a2.includes(loose) || b2.includes(loose);
  }

  function violatesFilters(item){
    const enabled = getEnabledPlatforms();
    if (!enabled.has(item.platform)) return true;

    // age target: 7–13
    if (item.ageMax < 7 || item.ageMin > 13) return true;

    if (!kindOk(item)) return true;
    if (mem.dislikes.includes(item.title)) return true;

    // “too babyish” suppression unless typed
    if (item.preschoolish && !isExplicitlyTyped(item.title)) return true;

    // avoid repeats in last 7 days
    const weekMs = 7*24*60*60*1000;
    if (mem.recentlyWatched.some(x => x.title === item.title && (Date.now()-x.ts) < weekMs)) return true;

    // quick filters
    const shortOnly = document.getElementById("fShort").checked;
    const noLoud = document.getElementById("fNoLoud").checked;
    const noSad = document.getElementById("fNoSad").checked;
    const noFight = document.getElementById("fNoFight").checked;

    if (shortOnly && !["short","10-20","20-30"].includes(item.episodeLen)) return true;
    if (noLoud && item.intensity === "medium") return true;
    if (noSad && /sad/.test(item.vibeTags.join(" "))) return true;
    if (noFight && /fight|battle|violence/.test(item.themes.join(" "))) return true;

    return false;
  }

  function scoreItem(item, tagsA, tagsB, mode){
    const overlap = new Set([...tagsA].filter(x => tagsB.includes(x)));
    let score = overlap.size * 3;

    const allTags = new Set([...tagsA, ...tagsB]);
    for (const t of allTags) {
      if (item.vibeTags.includes(t) || item.themes.includes(t)) score += 2;
    }

    if (mode === "Bedtime") {
      if (item.intensity === "low") score += 6;
      if (item.intensity === "medium") score -= 3;
      if (["short","10-20","20-30"].includes(item.episodeLen)) score += 1;
      if (item.kind === "movie") score -= 1;
    } else {
      if (item.intensity === "medium") score += 2;
      if (item.kind === "movie") score += 1;
    }

    // fairness nudge
    if (mem.lastWinner === "H") {
      const kFit = tagsB.filter(t => item.vibeTags.includes(t) || item.themes.includes(t)).length;
      score += kFit;
    }
    if (mem.lastWinner === "K") {
      const hFit = tagsA.filter(t => item.vibeTags.includes(t) || item.themes.includes(t)).length;
      score += hFit;
    }

    return { score, overlap: [...overlap] };
  }

  // ==========
  // Main recommend
  // ==========
  function pick3(){
    const pickA = document.getElementById("pickA").value.trim();
    const pickB = document.getElementById("pickB").value.trim();
    const mode = mem.mode;

    const scaryRequested = SCARY_WORDS.test(pickA) || SCARY_WORDS.test(pickB);

    let tagsA = tagsFromText(pickA);
    let tagsB = tagsFromText(pickB);

    if (tagsA.length === 0) tagsA = [mode==="Bedtime" ? "comfort" : "funny"];
    if (tagsB.length === 0) tagsB = [mode==="Bedtime" ? "comfort" : "funny"];

    if (scaryRequested) {
      tagsA = ["comfort","funny"];
      tagsB = ["comfort","curious"];
    }

    const lib = getLib();

    const candidates = [];
    for (const item of lib) {
      if (!modeOk(item, mode)) continue;
      if (violatesFilters(item)) continue;
      const s = scoreItem(item, tagsA, tagsB, mode);
      candidates.push({ item, ...s });
    }

    candidates.sort((a,b)=>b.score-a.score);
    let top = candidates.slice(0,3);

    // fallback: relax only "recently watched"
    if (top.length < 3) {
      const relaxed = [];
      const enabled = getEnabledPlatforms();
      for (const item of lib) {
        if (!enabled.has(item.platform)) continue;
        if (!modeOk(item, mode)) continue;
        if (!kindOk(item)) continue;
        if (mem.dislikes.includes(item.title)) continue;
        if (item.preschoolish && !isExplicitlyTyped(item.title)) continue;

        const s = scoreItem(item, tagsA, tagsB, mode);
        relaxed.push({ item, ...s });
      }
      relaxed.sort((a,b)=>b.score-a.score);
      top = relaxed.slice(0,3);
    }

    renderResults(top, {pickA, pickB, mode, scaryRequested, poolCount: candidates.length, totalCount: lib.length});
  }

  function renderResults(top, ctx){
    const out = document.getElementById("outCard");
    out.style.display = "block";

    document.getElementById("modePill").textContent = `Mode: ${ctx.mode}`;
    document.getElementById("fairPill").textContent = `Fairness: last winner ${mem.lastWinner || "none"}`;
    document.getElementById("memPill").textContent = `Memory: ${mem.likes.length} likes • ${mem.dislikes.length} no-thanks`;

    const enabled = [...getEnabledPlatforms()].join(", ");
    document.getElementById("platPill").textContent = `Platforms: ${enabled || "none"}`;
    document.getElementById("poolPill").textContent = `Pool: ${ctx.poolCount} matches • Library: ${ctx.totalCount}`;

    const container = document.getElementById("results");
    container.innerHTML = "";

    const header = document.createElement("div");
    header.className = "small";
    header.innerHTML = `
      <div><strong>H:</strong> ${escapeHtml(ctx.pickA || "(none)")}</div>
      <div><strong>K:</strong> ${escapeHtml(ctx.pickB || "(none)")}</div>
      ${ctx.scaryRequested ? `<div class="warn"><strong>Blocked:</strong> scary requests. Showing safe picks only.</div>` : ""}
    `;
    container.appendChild(header);

    const divider = document.createElement("div");
    divider.className = "divider";
    container.appendChild(divider);

    top.forEach((x, idx) => {
      const r = document.createElement("div");
      r.className = "result";
      r.innerHTML = `
        <p class="title">${idx+1}. ${escapeHtml(x.item.title)}</p>
        <div class="meta">${escapeHtml(x.item.platform)} • ${escapeHtml(x.item.kind)} • ${escapeHtml(x.item.episodeLen)} • intensity: ${escapeHtml(x.item.intensity)}</div>
        <div class="why">${escapeHtml(buildWhy(x, ctx))}</div>
        <div class="btnrow" style="margin-top:10px;">
          <button class="good" type="button" data-act="watched" data-title="${escapeAttr(x.item.title)}">We watched it</button>
          <button class="bad" type="button" data-act="dislike" data-title="${escapeAttr(x.item.title)}">No thanks</button>
        </div>
      `;
      container.appendChild(r);
    });

    container.addEventListener("click", onResultClick, { once:false });
  }

  function buildWhy(x, ctx){
    const bits = [];
    if (x.item.themes.includes("food")) bits.push("food/competition");
    if (x.item.themes.includes("science")) bits.push("curiosity");
    if (x.item.vibeTags.includes("comfort")) bits.push("comfort");
    if (x.item.vibeTags.includes("funny")) bits.push("funny");
    if (x.item.vibeTags.includes("music")) bits.push("music");
    bits.push(ctx.mode === "Bedtime" ? "bedtime pacing" : "weekend energy");
    return `Fits both of you with ${bits.join(", ")}.`;
  }

  function onResultClick(e){
    const btn = e.target.closest("button[data-act]");
    if (!btn) return;
    const act = btn.getAttribute("data-act");
    const title = btn.getAttribute("data-title");
    if (!title) return;

    if (act === "watched") {
      if (!mem.likes.includes(title)) mem.likes.push(title);
      mem.recentlyWatched.unshift({title, ts: Date.now()});
      mem.recentlyWatched = mem.recentlyWatched.slice(0, 120);

      const lib = getLib();
      const item = lib.find(x=>x.title===title);
      const tagsA = tagsFromText(document.getElementById("pickA").value);
      const tagsB = tagsFromText(document.getElementById("pickB").value);
      const aFit = tagsA.filter(t => item.vibeTags.includes(t) || item.themes.includes(t)).length;
      const bFit = tagsB.filter(t => item.vibeTags.includes(t) || item.themes.includes(t)).length;
      mem.lastWinner = (aFit === bFit) ? (mem.lastWinner === "H" ? "K" : "H") : (aFit > bFit ? "H" : "K");

      saveMem(mem);
      pick3();
    }

    if (act === "dislike") {
      if (!mem.dislikes.includes(title)) mem.dislikes.push(title);
      mem.likes = mem.likes.filter(x=>x!==title);
      saveMem(mem);
      pick3();
    }
  }

  // ==========
  // Mode
  // ==========
  function setMode(mode){
    mem.mode = mode;
    saveMem(mem);
    const bed = document.getElementById("modeBed");
    const wk = document.getElementById("modeWknd");
    const note = document.getElementById("modeNote");
    if (mode === "Bedtime") {
      bed.classList.add("primary"); wk.classList.remove("primary");
      note.textContent = "Bedtime = calmer, lower tension, avoid cliffhangers.";
    } else {
      wk.classList.add("primary"); bed.classList.remove("primary");
      note.textContent = "Weekend = more energy allowed (still safe, never scary).";
    }
  }

  // ==========
  // Add-title UI
  // ==========
  function showAdd(open){
    document.getElementById("addCard").style.display = open ? "block" : "none";
    if (open) renderCustomList();
  }

  function normalizeTitle(s){
    return (s||"").trim().replace(/\s+/g," ");
  }

  function saveNewTitle(){
    const title = normalizeTitle(document.getElementById("newTitle").value);
    const platform = document.getElementById("newPlatform").value;
    const kind = document.getElementById("newKind").value;
    const intensity = document.getElementById("newIntensity").value;
    const bedtimeOk = document.getElementById("newBedOk").checked;
    const weekendOk = document.getElementById("newWkndOk").checked;
    const preschoolish = document.getElementById("newPreschool").checked;

    const msg = document.getElementById("addMsg");
    msg.textContent = "";

    if (!title) { msg.textContent = "Type a title first."; return; }
    if (SCARY_WORDS.test(title)) { msg.innerHTML = `<div class="warn">That title looks scary/spooky by keyword. Skipping it.</div>`; return; }
    if (!bedtimeOk && !weekendOk) { msg.textContent = "Check Bedtime OK or Weekend OK (or both)."; return; }

    const rawTags = (document.getElementById("newTags").value || "").trim();
    let tags = rawTags ? rawTags.split(",").map(x=>x.trim().toLowerCase()).filter(Boolean) : autoTagsForTitle(title);

    // convert tags into vibeTags/themes split (lightweight)
    const vibeTags = [];
    const themes = [];
    for (const t of tags) {
      if (["funny","comfort","competition","curious","clever","music","uplifting","adventure","chaotic","fast"].includes(t)) vibeTags.push(t);
      else themes.push(t);
    }
    if (vibeTags.length === 0) vibeTags.push("comfort");
    if (themes.length === 0) themes.push("family");

    // If user adds something “babyish”, keep it suppressed unless typed
    const item = I(title, platform, kind, vibeTags, themes, intensity, kind==="movie" ? "movie" : "20-30", 7, 13, bedtimeOk, weekendOk, preschoolish);

    // prevent duplicates (title+platform+kind)
    const key = `${title}||${platform}||${kind}`.toLowerCase();
    const existing = (mem.customLib||[]).some(x => `${x.title}||${x.platform}||${x.kind}`.toLowerCase() === key);
    if (existing) { msg.textContent = "That title is already in your added list."; return; }

    mem.customLib = Array.isArray(mem.customLib) ? mem.customLib : [];
    mem.customLib.unshift(item);
    mem.customLib = mem.customLib.slice(0, 500); // cap to keep storage safe
    saveMem(mem);

    msg.innerHTML = `<div class="ok"><strong>Saved:</strong> ${escapeHtml(title)} (${platform})</div>`;
    document.getElementById("newTitle").value = "";
    document.getElementById("newTags").value = "";
    document.getElementById("newPreschool").checked = false;
    renderCustomList();
  }

  function renderCustomList(){
    const box = document.getElementById("customList");
    const items = Array.isArray(mem.customLib) ? mem.customLib : [];
    box.innerHTML = "";

    if (items.length === 0) {
      box.innerHTML = `<div class="small">No custom titles yet.</div>`;
      return;
    }

    items.slice(0, 30).forEach((it, idx) => {
      const d = document.createElement("div");
      d.className = "listItem";
      d.innerHTML = `
        <div>
          <b>${escapeHtml(it.title)}</b>
          <div class="sub">${escapeHtml(it.platform)} • ${escapeHtml(it.kind)} • ${escapeHtml(it.intensity)} • ${it.bedtimeOk ? "Bedtime" : ""}${it.bedtimeOk && it.weekendOk ? " & " : ""}${it.weekendOk ? "Weekend" : ""}${it.preschoolish ? " • typed-only" : ""}</div>
        </div>
        <div>
          <button class="bad" type="button" data-rm="${idx}">Remove</button>
        </div>
      `;
      box.appendChild(d);
    });

    box.onclick = (e) => {
      const btn = e.target.closest("button[data-rm]");
      if (!btn) return;
      const idx = parseInt(btn.getAttribute("data-rm"), 10);
      if (Number.isNaN(idx)) return;
      mem.customLib.splice(idx, 1);
      saveMem(mem);
      renderCustomList();
    };
  }

  // ==========
  // Helpers
  // ==========
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }
  function escapeAttr(s){ return escapeHtml(s).replace(/"/g,"&quot;"); }

  // ==========
  // Wire up UI
  // ==========
  document.getElementById("modeBed").addEventListener("click", ()=>setMode("Bedtime"));
  document.getElementById("modeWknd").addEventListener("click", ()=>setMode("Weekend"));
  document.getElementById("go").addEventListener("click", pick3);
  document.getElementById("reroll").addEventListener("click", pick3);

  document.getElementById("openAdd").addEventListener("click", ()=>showAdd(true));
  document.getElementById("closeAdd").addEventListener("click", ()=>showAdd(false));
  document.getElementById("saveAdd").addEventListener("click", saveNewTitle);

  document.getElementById("reset").addEventListener("click", ()=>{
    localStorage.removeItem(STORAGE_KEY);
    mem = loadMem();
    setMode(mem.mode);
    showAdd(false);
    document.getElementById("outCard").style.display = "none";
  });

  // rerun when toggles change
  ["pNetflix","pDisney","pParamount","pPeacock","fShort","fNoLoud","fNoSad","fNoFight","fMoviesOK","fShowsOK"].forEach(id=>{
    document.getElementById(id).addEventListener("change", ()=>{
      if (document.getElementById("outCard").style.display !== "none") pick3();
    });
  });

  // init
  setMode(mem.mode);
</script>
</body>
</html>